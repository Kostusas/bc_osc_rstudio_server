#!/usr/bin/env bash
set -x

echo $HOME

TMPBASE="${TMPDIR:-$HOME/rstudio-tmp}"

# 1) Per-job writable dirs + cookie
mkdir -p "$TMPBASE"/{var_run,var_lib,tmp/rstudio-server}

# Launch the RStudio Server
echo "Starting up rserver... at $(date)"

# Build the apptainer exec command
APPTAINER_CMD=(apptainer exec
  -B "${HOME}:${HOME}" \
  -B "$TMPBASE/var_run:/var/run" \
  -B "$TMPBASE/var_run:/run" \
  -B "$TMPBASE/var_lib:/var/lib/rstudio-server" \
  -B "$TMPBASE/tmp:/tmp" \
  <%= context.binds.blank? ? '' : "-B #{context.binds}" %>
  "<%= context.image %>")

exec "${APPTAINER_CMD[@]}" rserver \
  --www-port "${port}" \
  --server-user="$USER"

